<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‰²å½©çµäºº - Color Hunter</title>
    <style>
        /* å…¨å±€æ¨£å¼é‡è¨­èˆ‡åŸºæœ¬ä½ˆå±€ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Arial', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; min-height: 100vh; overflow-x: hidden;
        }
        .container { max-width: 400px; margin: 0 auto; padding: 20px; }
        .screen { display: none; min-height: 100vh; }
        .screen.active { display: block; }
        
        /* è¼¸å…¥æ¡†ã€æŒ‰éˆ•çµ±ä¸€æ¨£å¼ */
        input, select, button { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 25px; font-size: 16px; }
        button { background: #ff6b6b; color: white; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        button:hover { background: #ff5252; transform: scale(1.05); }
        button:disabled { background: #666; cursor: not-allowed; transform: none; }
        
        /* ç©å®¶åˆ—è¡¨é …ç›® */
        .player { display: flex; align-items: center; padding: 15px; margin: 10px 0; background: rgba(255,255,255,0.1); border-radius: 20px; }
        .player-avatar { width: 60px; height: 60px; border-radius: 50%; margin-right: 15px; object-fit: cover; background: #ccc; text-align: center; line-height: 60px; font-size: 32px; }
        .player-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        
        /* é ­åƒé è¦½èˆ‡ä¸Šå‚³æŒ‰éˆ• */
        .avatar-preview { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin: 10px auto; display: block; background: #ccc; border: 3px solid #fff; }
        .file-label { display: block; text-align: center; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 15px; cursor: pointer; margin: 10px 0; }
        
        /* é è¨­ emoji é ­åƒæ ¼å­ */
        .avatar-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin: 15px 0; }
        .avatar-option { 
            width: 50px; height: 50px; border-radius: 50%; 
            cursor: pointer; border: 3px solid transparent; transition: all 0.3s; 
            font-size: 32px; text-align: center; line-height: 50px; background: rgba(255,255,255,0.15);
        }
        .avatar-option.selected { border-color: #ffd700; transform: scale(1.15); box-shadow: 0 0 15px #ffd700; }
        .avatar-option img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        
        /* éŠæˆ²ä¸­ç›¸æ©Ÿèˆ‡ UI */
        .game-camera { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; }
        .game-ui { position: relative; z-index: 10; padding: 20px; }
        .color-target { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
            width: 200px; height: 200px; border-radius: 50%; border: 8px solid white;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5); text-align: center; padding-top: 70px;
            font-size: 24px; font-weight: bold;
        }
        .score-display { position: fixed; bottom: 150px; left: 50%; transform: translateX(-50%); 
            background: rgba(0,0,0,0.8); padding: 20px; border-radius: 25px; text-align: center; }
        .capture-btn { position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%);
            width: 120px; height: 120px; border-radius: 50%; background: #4ecdc4; border: 8px solid white;
            font-size: 20px; font-weight: bold; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* çµæœç•«é¢ */
        .result-grid { display: grid; gap: 15px; }
        .result-item { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 20px; display: flex; align-items: center; }
        .result-photo { width: 80px; height: 80px; border-radius: 15px; margin-right: 15px; object-fit: cover; }
        .ranking { font-size: 32px; font-weight: bold; text-align: center; margin: 20px 0; }
        
        /* ç‰ˆæ¬Šå®£å‘Š */
        .copyright {
            text-align: center;
            margin-top: 40px;
            font-size: 15px;
            font-weight: bold;
            color: rgba(255,255,255,0.85);
            padding: 15px;
            opacity: 0.9;
        }
        
        /* é›¢é–‹éŠæˆ²æŒ‰éˆ•ï¼ˆå›ºå®šå³ä¸Šè§’ï¼‰ */
        #exitGameBtn {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 9999;
            background: #e74c3c;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            border: none;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: all 0.2s;
        }
        #exitGameBtn:hover { background: #c0392b; transform: scale(1.05); }
        
        /* æˆ¿é–“è¨­å®šé …ç›®ï¼ˆæ°´å¹³æ’åˆ—ï¼ŒRWD æ™‚è®Šå‚ç›´ï¼‰ */
        .setting-row { display: flex; gap: 10px; align-items: center; margin: 10px 0; flex-wrap: wrap; }
        .setting-row label { flex: 1 1 150px; font-size: 15px; }
        .setting-row input { flex: 1 1 120px; max-width: 120px; }
        
        @media (max-width: 480px) { 
            .container { padding: 10px; } 
            .avatar-grid { grid-template-columns: repeat(5, 1fr); } 
            #exitGameBtn { top: 10px; right: 10px; padding: 8px 16px; font-size: 13px; }
            .setting-row { flex-direction: column; gap: 5px; }
        }
    </style>
</head>
<body>
    <!-- å…¨åŸŸé›¢é–‹éŠæˆ²æŒ‰éˆ•ï¼šæ¯å€‹ç•«é¢éƒ½æœ‰ï¼Œé»æ“Šå¾Œå¯é›¢é–‹ -->
    <button id="exitGameBtn">é›¢é–‹éŠæˆ² âœ–</button>

    <div class="container">
        <!-- ç•«é¢1ï¼šå»ºç«‹æˆ¿é–“ -->
        <div id="roomCreate" class="screen active">
            <h1>ğŸ¨ è‰²å½©çµäºº</h1>
            <input id="playerName" placeholder="è¼¸å…¥ä½ çš„åå­—" maxlength="12">
            
            <div>é¸æ“‡é ­åƒæˆ–ä¸Šå‚³ç…§ç‰‡ï¼š</div>
            <div class="avatar-grid" id="avatarGrid"></div>
            
            <label class="file-label" for="avatarUpload">ğŸ“¤ ä¸Šå‚³è‡ªå·±çš„ç…§ç‰‡ç•¶é ­åƒ</label>
            <input type="file" id="avatarUpload" accept="image/*" style="display:none;">
            <img id="avatarPreview" class="avatar-preview" src="" alt="ä¸Šå‚³é è¦½" style="display:none;">

            <!-- æˆ¿é–“è¨­å®šå€å¡Šï¼šæˆ¿ä¸»æ±ºå®šéŠæˆ²è¦å‰‡ -->
            <div class="setting-row">
                <label>æœ€å¤§åƒåŠ äººæ•¸ (2~100)</label>
                <input id="maxPlayers" type="number" min="2" max="100" value="10">
            </div>
            <div class="setting-row">
                <label>ç¸½å›åˆæ•¸ (1~20)</label>
                <input id="totalRounds" type="number" min="1" max="20" value="5">
            </div>
            <div class="setting-row">
                <label>æ¯å›åˆæ‹ç…§æ™‚é–“ (ç§’, 10~120)</label>
                <input id="roundSeconds" type="number" min="10" max="120" value="30">
            </div>
            
            <select id="gameMode">
                <option value="solo">å€‹äººæˆ° ğŸ†</option>
                <option value="team">åœ˜é«”æˆ° ğŸ‘¥</option>
            </select>
            <button onclick="createRoom()">å»ºç«‹æˆ¿é–“</button>

            <div class="copyright">
                Jerome Copyright Â© 2026
            </div>
        </div>

        <!-- ç•«é¢2ï¼šæˆ¿é–“ç®¡ç†ï¼ˆæˆ¿ä¸»çœ‹è¦‹ï¼‰ -->
        <div id="roomManage" class="screen">
            <h2 id="roomTitle">æˆ¿é–“å·²å»ºç«‹ï¼</h2>
            <div id="inviteUrl" style="word-break: break-all; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px; margin: 20px 0;"></div>
            <button onclick="copyInviteUrl()">è¤‡è£½é‚€è«‹é€£çµ</button>
            <div id="playersList"></div>
            <button id="startBtn" onclick="startGame()">é–‹å§‹éŠæˆ²ï¼ğŸš€</button>
        </div>

        <!-- ç•«é¢3ï¼šåŠ å…¥æˆ¿é–“ï¼ˆå…¶ä»–äººçœ‹è¦‹ï¼‰ -->
        <div id="joinRoom" class="screen">
            <h2>åŠ å…¥éŠæˆ²</h2>
            <input id="joinCode" placeholder="è²¼ä¸Šæˆ¿é–“é€£çµæˆ–ä»£ç¢¼">
            
            <div>é¸æ“‡é ­åƒæˆ–ä¸Šå‚³ç…§ç‰‡ï¼š</div>
            <div class="avatar-grid" id="joinAvatarGrid"></div>
            
            <label class="file-label" for="joinAvatarUpload">ğŸ“¤ ä¸Šå‚³è‡ªå·±çš„ç…§ç‰‡ç•¶é ­åƒ</label>
            <input type="file" id="joinAvatarUpload" accept="image/*" style="display:none;">
            <img id="joinAvatarPreview" class="avatar-preview" src="" alt="ä¸Šå‚³é è¦½" style="display:none;">
            
            <input id="joinName" placeholder="è¼¸å…¥ä½ çš„åå­—">
            <button onclick="joinRoom()">åŠ å…¥éŠæˆ²</button>
        </div>

        <!-- ç•«é¢4ï¼šéŠæˆ²é€²è¡Œä¸­ -->
        <div id="gameScreen" class="screen">
            <video id="camera" class="game-camera" autoplay muted playsinline></video>
            <div class="game-ui">
                <div id="colorTarget" class="color-target">æº–å‚™ä¸­...</div>
                <div id="scoreDisplay" class="score-display">
                    <div>æˆ‘çš„ç´¯è¨ˆ: <span id="currentScore">0</span> åˆ†</div>
                    <div>å‰©é¤˜æ™‚é–“: <span id="timer">30</span> ç§’</div>
                </div>
                <button id="captureBtn" class="capture-btn" onclick="capturePhoto()">ğŸ“¸ æ‹ï¼</button>
            </div>
        </div>

        <!-- ç•«é¢5ï¼šå›åˆçµæœ -->
        <div id="resultScreen" class="screen">
            <div id="ranking" class="ranking"></div>
            <div id="resultGrid" class="result-grid"></div>
            <button onclick="nextRound()" style="margin: 30px 10px; padding: 15px 30px; background:#2ecc71">ä¸‹ä¸€å›åˆ</button>
            <button onclick="endGame()" style="margin: 30px 10px; padding: 15px 30px; background:#e74c3c">çµæŸéŠæˆ²</button>
        </div>
    </div>

    <!-- PeerJS åº«ï¼šç”¨ä¾†åš P2P é€£ç·šï¼ˆä¸ç”¨è‡ªå·±æ¶ä¼ºæœå™¨ï¼‰ -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        // =============================================
        // éŠæˆ²å…¨å±€ç‹€æ…‹ï¼ˆæ‰€æœ‰ç•«é¢å…±ç”¨ï¼‰
        // =============================================
        let gameState = {
            roomId: null,                // æˆ¿é–“ IDï¼ˆå°±æ˜¯æˆ¿ä¸»çš„ Peer IDï¼‰
            isHost: false,               // æˆ‘æ˜¯ä¸æ˜¯æˆ¿ä¸»
            players: [],                 // ç›®å‰æ‰€æœ‰ç©å®¶åˆ—è¡¨
            myId: null,                  // æˆ‘çš„ Peer ID
            currentRound: 0,             // ç¾åœ¨æ˜¯ç¬¬å¹¾å›åˆ
            totalRounds: 5,              // ç¸½å›åˆæ•¸ï¼ˆæˆ¿ä¸»è¨­å®šï¼‰
            maxPlayers: 10,              // æœ€å¤§åƒåŠ äººæ•¸ï¼ˆæˆ¿ä¸»è¨­å®šï¼‰
            roundSeconds: 30,            // æ¯å›åˆæ‹ç…§ç§’æ•¸ï¼ˆæˆ¿ä¸»è¨­å®šï¼‰
            roomLocked: false,           // éŠæˆ²é–‹å§‹å¾Œé–å®šæˆ¿é–“ï¼Œä¸å†æ¥å—æ–°åŠ å…¥
            gameMode: 'solo',            // éŠæˆ²æ¨¡å¼ï¼šsolo æˆ– team
            currentColor: null,          // ç›®å‰å›åˆçš„ç›®æ¨™é¡è‰²
            gameActive: false,           // éŠæˆ²æ˜¯å¦æ­£åœ¨é€²è¡Œä¸­ï¼ˆç”¨ä¾†åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºå€’æ•¸ï¼‰
            timeLeft: 30,                // ç›®å‰å›åˆå‰©é¤˜æ™‚é–“
            myScore: 0,                  // æˆ‘çš„ç¸½åˆ†
            playerScores: {},            // å„ç©å®¶åˆ†æ•¸ï¼ˆæš«æ™‚æ²’ç”¨ï¼Œå¯æ“´å……ï¼‰
            roundPhotos: {},             // æ¯å›åˆçš„ç…§ç‰‡èˆ‡åˆ†æ•¸ {round: {playerId: {photo, score}}}
            accumulatedScores: {},       // ç´¯è¨ˆåˆ†æ•¸ï¼ˆç”¨æ–¼æœ€çµ‚æ’åï¼‰
            myAvatar: null,              // æˆ‘çš„é ­åƒï¼ˆbase64 æˆ– emojiï¼‰
            selectedEmojiIndex: 0        // é è¨­é¸ä¸­çš„ emoji ç´¢å¼•
        };

        // é è¨­ emoji é ­åƒæ¸…å–®
        const avatars = ['ğŸ‘¨', 'ğŸ‘©', 'ğŸ§‘â€ğŸ¦±', 'ğŸ§”', 'ğŸ‘¦', 'ğŸ‘§', 'ğŸ§’', 'ğŸ‘¨â€ğŸ¦°', 'ğŸ‘©â€ğŸ¦°', 'ğŸ¶', 'ğŸ±', 'ğŸ¦Š', 'ğŸ¦', 'ğŸ¼', 'ğŸ¤–'];

        // ç”¢ç”Ÿç¨ä¸€ç„¡äºŒçš„ Peer IDï¼ˆç”¨ä¾†ç•¶æˆ¿é–“ä»£ç¢¼ï¼‰
        const peerId = 'colorhunter_' + Math.random().toString(36).substr(2, 9);
        let peer = new Peer(peerId, { host: 'peerjs.com', port: 443, path: '/peerjs' });
        let conn;  // èˆ‡æˆ¿ä¸»çš„é€£ç·šç‰©ä»¶

        // Peer é€£ç·šäº‹ä»¶
        peer.on('open', id => console.log('æˆ‘çš„ Peer ID:', id));
        peer.on('connection', c => {
            conn = c;
            conn.on('data', handleData);
        });

        // åˆå§‹åŒ–æ‰€æœ‰ç•«é¢çš„ emoji é ­åƒé¸æ“‡æ ¼å­
        function initAvatarGrids() {
            const grids = [
                { id: 'avatarGrid', previewId: 'avatarPreview', isCreate: true },
                { id: 'joinAvatarGrid', previewId: 'joinAvatarPreview', isCreate: false }
            ];

            grids.forEach(gridInfo => {
                const grid = document.getElementById(gridInfo.id);
                avatars.forEach((emoji, i) => {
                    const div = document.createElement('div');
                    div.className = 'avatar-option';
                    div.textContent = emoji;
                    div.dataset.index = i;
                    div.onclick = () => selectEmoji(div, i, gridInfo.previewId, gridInfo.isCreate);
                    grid.appendChild(div);
                });
                // é è¨­é¸ç¬¬ä¸€å€‹
                grid.querySelector('.avatar-option').classList.add('selected');
            });
        }

        // é»é¸ emoji æ™‚çš„è™•ç†
        function selectEmoji(el, index, previewId, isCreate) {
            // ç§»é™¤åŒç•«é¢çš„å…¶ä»–é¸ä¸­ç‹€æ…‹
            el.parentElement.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            
            gameState.selectedEmojiIndex = index;
            gameState.myAvatar = avatars[index];
            
            // éš±è—ä¸Šå‚³ç…§ç‰‡é è¦½ï¼ˆå› ç‚ºæ”¹é¸ emoji äº†ï¼‰
            document.getElementById(previewId).style.display = 'none';
            document.getElementById(previewId).src = '';
        }

        // ä¸Šå‚³ç…§ç‰‡çš„è™•ç†ï¼ˆå…±ç”¨å‡½å¼ï¼‰
        document.getElementById('avatarUpload').addEventListener('change', e => handleAvatarUpload(e, 'avatarPreview', true));
        document.getElementById('joinAvatarUpload').addEventListener('change', e => handleAvatarUpload(e, 'joinAvatarPreview', false));

        function handleAvatarUpload(e, previewId, isCreate) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 1024 * 1024) {
                alert('ç…§ç‰‡è«‹å°æ–¼ 1MBï¼');
                e.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                gameState.myAvatar = event.target.result;
                const preview = document.getElementById(previewId);
                preview.src = gameState.myAvatar;
                preview.style.display = 'block';

                // å–æ¶ˆ emoji é¸ä¸­ç‹€æ…‹ï¼ˆè¦–è¦ºä¸Šè¡¨ç¤ºç”¨ç…§ç‰‡å„ªå…ˆï¼‰
                const gridId = isCreate ? 'avatarGrid' : 'joinAvatarGrid';
                document.getElementById(gridId).querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
            };
            reader.readAsDataURL(file);
        }

        // å»ºç«‹æˆ¿é–“ï¼šæˆ¿ä¸»è¨­å®šæ‰€æœ‰éŠæˆ²è¦å‰‡
        function createRoom() {
            const name = document.getElementById('playerName').value.trim() || 'ç¥ç§˜çµäºº';
            gameState.myId = peerId;
            gameState.isHost = true;
            gameState.gameMode = document.getElementById('gameMode').value;
            
            // è®€å–æˆ¿ä¸»è¨­å®šçš„åƒæ•¸ï¼Œä¸¦åšåˆç†ç¯„åœé™åˆ¶
            gameState.maxPlayers = Math.max(2, Math.min(100, parseInt(document.getElementById('maxPlayers').value) || 10));
            gameState.totalRounds = Math.max(1, Math.min(20, parseInt(document.getElementById('totalRounds').value) || 5));
            gameState.roundSeconds = Math.max(10, Math.min(120, parseInt(document.getElementById('roundSeconds').value) || 30));
            gameState.roomLocked = false;  // ä¸€é–‹å§‹æœªé–å®š

            // åŠ å…¥è‡ªå·±ç‚ºç¬¬ä¸€ä½ç©å®¶
            gameState.players = [{
                id: peerId,
                name,
                avatar: gameState.myAvatar || avatars[gameState.selectedEmojiIndex],
                score: 0,
                team: null
            }];

            // åˆ‡æ›åˆ°æˆ¿é–“ç®¡ç†ç•«é¢
            showScreen('roomManage');
            document.getElementById('roomTitle').textContent = `${name} çš„æˆ¿é–“ (æœ€å¤š ${gameState.maxPlayers} äºº, æ¯å›åˆ ${gameState.roundSeconds} ç§’)`;
            const url = window.location.href.split('?')[0] + '?room=' + peerId;
            document.getElementById('inviteUrl').textContent = url;
            updatePlayerList();
        }

        // è¤‡è£½é‚€è«‹é€£çµ
        function copyInviteUrl() {
            const text = document.getElementById('inviteUrl').textContent;
            navigator.clipboard.writeText(text).then(() => alert('é‚€è«‹é€£çµå·²è¤‡è£½ï¼å¿«å‚³çµ¦æœ‹å‹ï½'));
        }

        // åŠ å…¥æˆ¿é–“ï¼ˆå…¶ä»–äººåŸ·è¡Œï¼‰
        function joinRoom() {
            let roomCode = document.getElementById('joinCode').value.trim();
            if (!roomCode) {
                const params = new URLSearchParams(window.location.search);
                roomCode = params.get('room');
            }
            if (!roomCode) return alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æˆ¿é–“é€£çµæˆ–ä»£ç¢¼');

            const name = document.getElementById('joinName').value.trim() || 'ç¥ç§˜çµäºº';

            conn = peer.connect(roomCode);
            conn.on('open', () => {
                gameState.myId = peerId;
                conn.send({
                    type: 'join',
                    player: {
                        id: peerId,
                        name,
                        avatar: gameState.myAvatar || avatars[gameState.selectedEmojiIndex]
                    }
                });
            });
            conn.on('data', handleData);
        }

        // æ¥æ”¶ä¾†è‡ªå…¶ä»–ç©å®¶çš„è³‡æ–™ï¼ˆæœ€é‡è¦çš„è¨Šæ¯è™•ç†ä¸­å¿ƒï¼‰
        function handleData(data) {
            // åŠ å…¥è¢«æ‹’çµ•ï¼ˆæˆ¿æ»¿ã€å·²é–å®šã€éŠæˆ²é–‹å§‹ï¼‰
            if (data.type === 'joinRejected') {
                alert(data.message || 'ç„¡æ³•åŠ å…¥ï¼šæˆ¿é–“å·²æ»¿ã€å·²é–å®šæˆ–éŠæˆ²å·²é–‹å§‹');
                if (conn) conn.close();
                showScreen('joinRoom'); // å›åˆ°åŠ å…¥ç•«é¢è®“ä»–å†è©¦
                return;
            }

            // æ›´æ–°ç©å®¶åˆ—è¡¨ï¼ˆæˆ¿ä¸»æœƒå»£æ’­ï¼‰
            if (data.type === 'playerList') {
                gameState.players = data.players;
                updatePlayerList();
            }

            // æˆ¿ä¸»é–‹å§‹éŠæˆ²ï¼Œå»£æ’­è¨­å®šçµ¦æ‰€æœ‰äºº
            if (data.type === 'startGame') {
                gameState.gameMode = data.gameMode;
                gameState.totalRounds = data.totalRounds;
                gameState.roundSeconds = data.roundSeconds;
                gameState.currentRound = 0;
                gameState.roomLocked = true;
                startRound();
            }

            // æˆ¿ä¸»å»£æ’­æœ¬å›åˆç›®æ¨™é¡è‰²
            if (data.type === 'colorTarget') {
                gameState.currentColor = data.color;
                updateColorTarget();
            }

            // æœ‰äººæäº¤ç…§ç‰‡èˆ‡åˆ†æ•¸
            if (data.type === 'photoSubmit') {
                if (!gameState.roundPhotos[data.round]) gameState.roundPhotos[data.round] = {};
                gameState.roundPhotos[data.round][data.playerId] = { photo: data.photo, score: data.score };
            }

            // æˆ¿ä¸»çµæŸå›åˆï¼Œå»£æ’­çµ¦æ‰€æœ‰äººçœ‹çµæœ
            if (data.type === 'endRound') {
                showResults();
            }

            // æˆ¿ä¸»ç™¼èµ·ä¸‹ä¸€å›åˆ
            if (data.type === 'nextRound') {
                gameState.currentRound++;
                if (gameState.currentRound < gameState.totalRounds) {
                    startRound();
                } else {
                    endGame();
                }
            }
        }

        // æ›´æ–°ç©å®¶åˆ—è¡¨é¡¯ç¤º
        function updatePlayerList() {
            const list = document.getElementById('playersList');
            list.innerHTML = gameState.players.map(p => `
                <div class="player">
                    <div class="player-avatar">
                        ${p.avatar.startsWith('data:') ? `<img src="${p.avatar}" alt="">` : p.avatar}
                    </div>
                    <div>${p.name}${p.team ? ` (${p.team}éšŠ)` : ''}</div>
                </div>
            `).join('');
            if (document.getElementById('startBtn')) {
                document.getElementById('startBtn').disabled = gameState.players.length < 2;
            }
        }

        // é–‹å§‹éŠæˆ²ï¼ˆåªæœ‰æˆ¿ä¸»èƒ½æŒ‰ï¼‰
        async function startGame() {
            if (gameState.players.length < 2) return alert('è‡³å°‘éœ€è¦ 2 äººæ‰èƒ½é–‹å§‹éŠæˆ²ï¼');
            gameState.roomLocked = true; // é–‹å§‹å¾Œé–å®šï¼Œä¸å†æ¥å—æ–°ç©å®¶

            // å¦‚æœæ˜¯åœ˜é«”æˆ°ï¼Œéš¨æ©Ÿåˆ†çµ„
            if (gameState.gameMode === 'team') {
                let shuffled = [...gameState.players];
                shuffled.sort(() => Math.random() - 0.5);
                shuffled.forEach((p, i) => p.team = i % 2 === 0 ? 'A' : 'B');
                gameState.players = shuffled;
                if (conn) conn.send({ type: 'playerList', players: gameState.players });
            }

            // å»£æ’­é–‹å§‹éŠæˆ²èˆ‡è¨­å®šçµ¦æ‰€æœ‰ç©å®¶
            if (conn) conn.send({ 
                type: 'startGame', 
                gameMode: gameState.gameMode, 
                totalRounds: gameState.totalRounds,
                roundSeconds: gameState.roundSeconds 
            });
            startRound();
        }

        // é–‹å§‹ä¸€å›åˆï¼ˆæ‰€æœ‰äººéƒ½æœƒåŸ·è¡Œï¼‰
        async function startRound() {
            showScreen('gameScreen');
            gameState.gameActive = true;
            gameState.timeLeft = gameState.roundSeconds;
            gameState.currentColor = colors[Math.floor(Math.random() * colors.length)];

            if (gameState.isHost && conn) {
                conn.send({ type: 'colorTarget', color: gameState.currentColor });
            }
            updateColorTarget();

            await initCamera();
            requestFullscreen();

            const timer = document.getElementById('timer');
            timer.textContent = gameState.timeLeft;

            const interval = setInterval(() => {
                gameState.timeLeft--;
                timer.textContent = gameState.timeLeft;
                if (gameState.timeLeft <= 0) {
                    clearInterval(interval);
                    endRound();
                }
            }, 1000);
        }

        // è«‹æ±‚ç€è¦½å™¨é€²å…¥å…¨è¢å¹•æ¨¡å¼ï¼ˆéš±è—ç¶²å€åˆ—ï¼‰
        function requestFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(err => console.log('å…¨è¢å¹•è¢«æ‹’çµ•', err));
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        }

        // æ›´æ–°ç›®æ¨™é¡è‰²é¡¯ç¤º
        function updateColorTarget() {
            const el = document.getElementById('colorTarget');
            el.style.background = gameState.currentColor.hex;
            el.innerHTML = `${gameState.currentColor.name}<br>å¿«å»æ‰¾ï¼`;
        }

        // é–‹å•Ÿå¾Œç½®ç›¸æ©Ÿ
        let video;
        async function initCamera() {
            video = document.getElementById('camera');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = stream;
            } catch (err) {
                alert('éœ€è¦é–‹å•Ÿç›¸æ©Ÿæ¬Šé™æ‰èƒ½ç©å–”ï½ è«‹å…è¨±å¾Œé‡æ–°è¼‰å…¥é é¢');
            }
        }

        // å¿«é–€éŸ³æ•ˆï¼ˆå…è²»å…¬é–‹é€£çµï¼‰
        const shutterSound = new Audio('https://www.soundjay.com/mechanical/camera-shutter-click-01.mp3');

        // ç©å®¶æŒ‰ä¸‹æ‹ç…§æŒ‰éˆ•
        async function capturePhoto() {
            if (!video || !gameState.gameActive) return;

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // æ‹ç…§é–ƒå…‰ç‰¹æ•ˆ
            const flash = document.createElement('div');
            flash.style.cssText = 'position:fixed;inset:0;background:white;opacity:0.7;transition:opacity 0.15s;z-index:9999;pointer-events:none;';
            document.body.appendChild(flash);
            setTimeout(() => flash.style.opacity = '0', 80);
            setTimeout(() => document.body.removeChild(flash), 300);

            // æ‰‹æ©Ÿéœ‡å‹•
            navigator.vibrate?.(50);

            // æ’­æ”¾å¿«é–€è²
            try {
                shutterSound.currentTime = 0;
                await shutterSound.play();
            } catch (e) { console.log('éŸ³æ•ˆæ’­æ”¾å¤±æ•—', e); }

            // è¨ˆç®—ç…§ç‰‡å¹³å‡é¡è‰²ï¼ˆç¸®å°åˆ° 1x1 å–è‰²ï¼‰
            const small = document.createElement('canvas');
            small.width = 1; small.height = 1;
            small.getContext('2d').drawImage(canvas, 0, 0, canvas.width, canvas.height, 0, 0, 1, 1);
            const [r, g, b] = small.getContext('2d').getImageData(0,0,1,1).data;

            const capturedHSV = rgbToHsv(r, g, b);
            const targetHSV = gameState.currentColor.hsv;

            const dist = hsvDistance(capturedHSV, targetHSV);
            const maxDist = 220; // ç¶“é©—å€¼ï¼ŒHSV è·é›¢æœ€å¤§åˆç†å€¼
            let score = Math.max(0, 100 - Math.round((dist / maxDist) * 100));
            score = Math.round(score * (0.9 + Math.random() * 0.2)); // åŠ ä¸€é»éš¨æ©Ÿè®“åˆ†æ•¸æœ‰è¶£

            gameState.myScore += score;
            document.getElementById('currentScore').textContent = gameState.myScore;

            const photo = canvas.toDataURL('image/jpeg', 0.75);

            if (!gameState.roundPhotos[gameState.currentRound]) {
                gameState.roundPhotos[gameState.currentRound] = {};
            }
            gameState.roundPhotos[gameState.currentRound][gameState.myId] = { photo, score };

            showScorePopup(score);

            // é€çµ¦æˆ¿ä¸»ï¼ˆæˆ¿ä¸»å†å»£æ’­çµ¦æ‰€æœ‰äººï¼‰
            if (conn) {
                conn.send({
                    type: 'photoSubmit',
                    round: gameState.currentRound,
                    playerId: gameState.myId,
                    photo,
                    score
                });
            }
        }

        // RGB è½‰ HSVï¼ˆç”¨ä¾†è¨ˆç®—é¡è‰²ç›¸ä¼¼åº¦ï¼‰
        function rgbToHsv(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            let max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, v = max;
            let d = max - min;
            s = max === 0 ? 0 : d / max;
            if (max === min) h = 0;
            else {
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return [Math.round(h * 360), Math.round(s * 100), Math.round(v * 100)];
        }

        // HSV é¡è‰²è·é›¢ï¼ˆè€ƒæ…®è‰²ç›¸æ˜¯åœ“å½¢ï¼‰
        function hsvDistance(hsv1, hsv2) {
            let [h1, s1, v1] = hsv1;
            let [h2, s2, v2] = hsv2;
            let dh = Math.min(Math.abs(h1 - h2), 360 - Math.abs(h1 - h2));
            let ds = Math.abs(s1 - s2);
            let dv = Math.abs(v1 - v2);
            return Math.sqrt(dh**2 + ds**2 * 0.4 + dv**2 * 0.4);
        }

        // åˆ†æ•¸å½ˆå‡ºç‰¹æ•ˆ
        function showScorePopup(score) {
            const popup = document.createElement('div');
            popup.textContent = `+${score}`;
            popup.style.cssText = `position:fixed; left:50%; top:40%; transform:translate(-50%,-50%);
                font-size:70px; font-weight:bold; 
                color:${score>80?'#2ecc71':score>50?'#f1c40f':'#e74c3c'};
                text-shadow:3px 3px 12px black; pointer-events:none; z-index:10000; opacity:0; transition:all 1s;`;
            document.body.appendChild(popup);

            setTimeout(() => {
                popup.style.opacity = '1';
                popup.style.transform = 'translate(-50%, -100%) scale(1.3)';
            }, 10);
            setTimeout(() => {
                popup.style.opacity = '0';
                popup.style.transform = 'translate(-50%, -150%)';
            }, 900);
            setTimeout(() => document.body.removeChild(popup), 1600);
        }

        // å›åˆçµæŸï¼ˆæ™‚é–“åˆ°æˆ–æˆ¿ä¸»æ‰‹å‹•ï¼‰
        function endRound() {
            gameState.gameActive = false;
            if (gameState.isHost && conn) {
                conn.send({ type: 'endRound' });
            }
            showResults();
        }

        // é¡¯ç¤ºå›åˆçµæœï¼ˆæˆ¿ä¸»å»£æ’­å¾Œå¤§å®¶éƒ½æœƒåŸ·è¡Œï¼‰
        function showResults() {
            showScreen('resultScreen');
            const ranking = document.getElementById('ranking');
            const grid = document.getElementById('resultGrid');
            grid.innerHTML = '';

            let roundResults = gameState.roundPhotos[gameState.currentRound] || {};

            // ç´¯è¨ˆåˆ†æ•¸
            Object.keys(roundResults).forEach(id => {
                if (!gameState.accumulatedScores[id]) gameState.accumulatedScores[id] = 0;
                gameState.accumulatedScores[id] += roundResults[id].score || 0;
            });

            ranking.textContent = gameState.currentRound + 1 >= gameState.totalRounds ? 'ğŸ‰ éŠæˆ²çµæŸï¼æœ€çµ‚æ’å' : `ç¬¬ ${gameState.currentRound + 1} å›åˆçµæœ`;

            const sortedPlayers = gameState.players
                .map(p => ({
                    ...p,
                    thisRound: roundResults[p.id]?.score || 0,
                    photo: roundResults[p.id]?.photo || '',
                    total: gameState.accumulatedScores[p.id] || 0
                }))
                .sort((a, b) => b.total - a.total);

            sortedPlayers.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.innerHTML = `
                    <div style="font-size:28px; margin-right:15px;">${i+1}.</div>
                    <div class="player-avatar">
                        ${p.avatar.startsWith('data:') ? `<img src="${p.avatar}" alt="">` : p.avatar}
                    </div>
                    <div style="flex:1">
                        <strong>${p.name}</strong><br>
                        æœ¬å›åˆ: ${p.thisRound} åˆ†<br>
                        ç¸½åˆ†: ${p.total} åˆ†
                    </div>
                    ${p.photo ? `<img src="${p.photo}" class="result-photo">` : ''}
                `;
                grid.appendChild(div);
            });
        }

        // ä¸‹ä¸€å›åˆï¼ˆåªæœ‰æˆ¿ä¸»èƒ½æŒ‰ï¼‰
        function nextRound() {
            if (gameState.isHost && conn) {
                conn.send({ type: 'nextRound' });
            }
        }

        // éŠæˆ²å®Œå…¨çµæŸ
        function endGame() {
            alert('éŠæˆ²çµæŸï¼æ„Ÿè¬åƒèˆ‡ï½');
            location.reload(); // é‡æ–°è¼‰å…¥å›åˆ°èµ·å§‹ç•«é¢
        }

        // åˆ‡æ›ç•«é¢
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // é›¢é–‹éŠæˆ²æŒ‰éˆ•ï¼ˆæ‰€æœ‰ç•«é¢å…±ç”¨ï¼‰
        document.getElementById('exitGameBtn').addEventListener('click', () => {
            if (confirm('ç¢ºå®šè¦é›¢é–‹éŠæˆ²å—ï¼Ÿæˆ¿é–“é€£ç·šæœƒæ–·é–‹å–”ï½')) {
                if (conn) conn.close();
                if (peer) peer.destroy();
                try {
                    window.close(); // å˜—è©¦é—œé–‰åˆ†é 
                } catch (e) {
                    // è‹¥ç€è¦½å™¨ä¸å…è¨±é—œé–‰ï¼Œå°±å›åˆ°å»ºç«‹æˆ¿é–“ç•«é¢
                    showScreen('roomCreate');
                    // é‡ç½®éŠæˆ²ç‹€æ…‹
                    gameState = {
                        roomId: null, isHost: false, players: [], myId: null,
                        currentRound: 0, totalRounds: 5, maxPlayers: 10, roundSeconds: 30,
                        roomLocked: false, gameMode: 'solo', currentColor: null,
                        gameActive: false, timeLeft: 30, myScore: 0,
                        playerScores: {}, roundPhotos: {}, accumulatedScores: {},
                        myAvatar: null, selectedEmojiIndex: 0
                    };
                }
            }
        });

        // é˜²æ­¢èª¤æŒ‰ç€è¦½å™¨ä¸Šä¸€é ï¼ˆæœƒå½ˆå‡ºç¢ºèªè¦–çª—ï¼‰
        window.addEventListener('beforeunload', function (e) {
            if (gameState.players.length > 0 || gameState.gameActive) {
                e.preventDefault();
                e.returnValue = 'éŠæˆ²é€²è¡Œä¸­ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿé€£ç·šæœƒæ–·é–‹ã€‚';
            }
        });

        // åˆå§‹åŒ–æ‰€æœ‰æ±è¥¿
        initAvatarGrids();

        // è‡ªå‹•åµæ¸¬å¦‚æœæœ‰ ?room=xxx å°±è·³åˆ°åŠ å…¥ç•«é¢
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            if (params.has('room')) {
                showScreen('joinRoom');
                document.getElementById('joinCode').value = params.get('room');
            }
        };
    </script>
</body>
</html>